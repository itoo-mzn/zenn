---
title: "ã€Œé”äººã«å­¦ã¶SQLå¾¹åº•æŒ‡å—æ›¸ã€è¦ç‚¹"
emoji: "ðŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["SQL"]
published: false
---

# æ›¸ç±
https://www.shoeisha.co.jp/book/detail/9784798157825

## ã‚µãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸
http://mickindex.sakura.ne.jp/database/db_support_sinan.html

# ç¬¬1éƒ¨ã€€é­”æ³•ã®SQL
## 1.ã€€CASEå¼ã®ã‚¹ã‚¹ãƒ¡
- CASEå¼ã§**æ¡ä»¶åˆ†å²**ã‚’è¨˜è¿°ã§ãã‚‹ã€‚
- CASEå¼ã§ã¯ã€**çœŸã«ãªã‚‹æ¡ä»¶(WHENå¥)ãŒè¦‹ã¤ã‹ã£ãŸæ™‚ç‚¹ã§æ‰“ã¡åˆ‡ã‚‰ã‚Œã¦ã€æ®‹ã‚Šã®WHENå¥ã¯è©•ä¾¡ã•ã‚Œãªã„**ã®ã§è¦æ³¨æ„ã€‚
- å„åˆ†å²ãŒè¿”ã™çµæžœã®ãƒ‡ãƒ¼ã‚¿åž‹(THENå¥)ã¯çµ±ä¸€ã—ãªã„ã¨ã„ã‘ãªã„ã€‚
- **ELSEå¥ã¯æ›¸ã**ã‚¯ã‚»ã‚’ã¤ã‘ã‚‹ã€‚(æ›¸ã‹ãªã„ã¨æš—é»™çš„ã«NULLã«ãªã‚Šã€ãƒã‚°ã®æ¸©åºŠã«ãªã‚‹ãŸã‚)

### æ–°ã—ã„ä½“ç³»ã«å¤‰æ›ã—ã¦é›†è¨ˆ
| çœŒå | çœŒã®äººå£ |
| - | - |

â†“
| åœ°æ–¹å | åœ°æ–¹ã”ã¨ã®åˆè¨ˆäººå£ |
| - | - |

```sql:å…¨ã¦ã®DBMSã§ä½¿ãˆã‚‹
SELECT
  --
  CASE pref_name
    WHEN 'å¾³å³¶' THEN 'å››å›½'
    WHEN 'æ„›åª›' THEN 'å››å›½'
    WHEN 'é¦™å·' THEN 'å››å›½'
    WHEN 'é«˜çŸ¥' THEN 'å››å›½'
    WHEN 'ä½è³€' THEN 'ä¹å·ž'
    WHEN 'ç¦å²¡' THEN 'ä¹å·ž'
    WHEN 'é•·å´Ž' THEN 'ä¹å·ž'
    ELSE 'ãã®ä»–'
  END AS 'åœ°æ–¹å', -- åœ°æ–¹åã‚’å‡ºåŠ›ã™ã‚‹ãŸã‚ã®CASEå¼
  --
  SUM(population) AS 'åœ°æ–¹ã”ã¨ã®äººå£' -- åœ°æ–¹ã”ã¨ã®äººå£ (ã»ã—ã„ãƒ‡ãƒ¼ã‚¿)
FROM
  PopTbl
GROUP BY
  --
  CASE pref_name -- SELECTå¥ã¨åŒã˜CASEã‚’ä½¿ã†
    WHEN 'å¾³å³¶' THEN 'å››å›½'
    WHEN 'æ„›åª›' THEN 'å››å›½'
    WHEN 'é¦™å·' THEN 'å››å›½'
    WHEN 'é«˜çŸ¥' THEN 'å››å›½'
    WHEN 'ä½è³€' THEN 'ä¹å·ž'
    WHEN 'ç¦å²¡' THEN 'ä¹å·ž'
    WHEN 'é•·å´Ž' THEN 'ä¹å·ž'
    ELSE 'ãã®ä»–'
  END -- çœŒâ†’åœ°æ–¹ã¨ã„ã†æ–°ã—ã„ä½“ç³»ã«å¤‰æ›ã™ã‚‹ãŸã‚ã®GROUP BYã«ä½¿ã†CASEå¼
  --
;
```
MySQL, PostgreSQLã¯åˆ—ã‚’å…ˆã«è¨ˆç®—ã™ã‚‹ãŸã‚ã€åŒã˜ã“ã¨ã‚’ä¸‹è¨˜SQLã§ã‚¹ãƒƒã‚­ãƒªæ›¸ãã“ã¨ãŒã§ãã‚‹ã€‚
```sql:MySQL, PostgreSQLã§ä½¿ãˆã‚‹
SELECT
  CASE pref_name
    WHEN 'å¾³å³¶' THEN 'å››å›½'
    WHEN 'æ„›åª›' THEN 'å››å›½'
    WHEN 'é¦™å·' THEN 'å››å›½'
    WHEN 'é«˜çŸ¥' THEN 'å››å›½'
    WHEN 'ä½è³€' THEN 'ä¹å·ž'
    WHEN 'ç¦å²¡' THEN 'ä¹å·ž'
    WHEN 'é•·å´Ž' THEN 'ä¹å·ž'
    ELSE 'ãã®ä»–'
  END AS 'åœ°æ–¹å',
  SUM(population) AS 'åœ°æ–¹ã”ã¨ã®äººå£'
FROM
  PopTbl
GROUP BY
  åœ°æ–¹å -- 'ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³'ã‚’ã¤ã‘ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã—ãŸ
;
```

### ç•°ãªã‚‹æ¡ä»¶ã®é›†è¨ˆã‚’1ã¤ã®SQLã§è¡Œã†
ä»¥ä¸‹ã®ã‚ˆã†ã«CASEå¼ã‚’åˆ©ç”¨ã™ã‚Œã°ã€**ã‚¯ãƒ­ã‚¹è¡¨ã‚’ä½œã‚‹ã“ã¨ãŒã§ã**ã€é›†è¨ˆã‚’ã™ã‚‹ã¨ãã«ä¾¿åˆ©ã€‚
([ã‚¯ãƒ­ã‚¹è¡¨ã¨ã¯](https://trim-site.co.jp/vocabulary/totalling/cross-tabulation/))

| çœŒå | æ€§åˆ¥ | çœŒã®äººå£ |
| - | - | - |

â†“
| çœŒå | ç”·æ€§ã®äººå£ | å¥³æ€§ã®äººå£ |
| - | - | - |
```sql
SELECT
  pref_name,
  -- ç”·æ€§ã®å ´åˆãƒ»å¥³æ€§ã®å ´åˆã®2ã¤ã®æƒ…å ±ã®ã†ã¡ã€ç”·æ€§ã®æƒ…å ±ä»¥å¤–ã‚’0ã«ã—ã¦ã€ç”·æ€§ã®å ´åˆã®æ•°(äººå£)ã‚’æ±‚ã‚ã‚‹
  SUM(CASE sex WHEN 1 THEN population ELSE 0 END) AS 'ç”·æ€§', 
  SUM(CASE sex WHEN 2 THEN population ELSE 0 END) AS 'å¥³æ€§'
FROM
  `PopTbl2`
GROUP BY
  pref_name -- ã“ã‚Œã«ã‚ˆã£ã¦1ã¤ã®çœŒãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã€ç”·æ€§ãƒ»å¥³æ€§ã®2ã¤ã®æƒ…å ±ãŒã¶ã‚‰ä¸‹ãŒã‚‹
;
```
1ã¤ã®SQLã§ã‚ã‚‹ãŸã‚ã€2å›žSQLã‚’ç™ºè¡Œã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§å±•é–‹ã™ã‚‹ or UNIONã™ã‚‹ ã‚ˆã‚Šã‚‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒè‰¯ã„ã€‚

:::message
ãƒ—ãƒ­ã¯WHEREå¥ã§ãªãã€SELECTå¥ã§æ¡ä»¶åˆ†å²ã•ã›ã‚‹ã€‚
ãƒ—ãƒ­ã¯HAVINGå¥ã§ãªãã€SELECTå¥ã§æ¡ä»¶åˆ†å²ã•ã›ã‚‹ã€‚
:::

### è¤‡æ•°ã®åˆ—ã‚’ä½¿ã£ãŸæ¡ä»¶ã‚’å®šç¾©
CASEå¼ã‚’å…¥ã‚Œå­ã«ã™ã‚‹ã“ã¨ã§ã€ãƒã‚¹ãƒˆã—ãŸæ¡ä»¶åˆ†å²ã‚’è¡¨ç¾ã§ãã‚‹ã€‚
```sql
SELECT
  *,
  -- ç”·æ€§ã®äººå£ãŒ100äººä»¥ä¸Šã®çœŒã¯1, ãã‚Œä»¥å¤–ã¯0
  CASE sex
    WHEN 1 THEN CASE
      WHEN population >= 100 THEN 1
      ELSE 0
    END
    ELSE 0
  END
FROM
  PopTbl2
;
```

### æ¡ä»¶ã‚’åˆ†å²ã—ã¦UPDATEã™ã‚‹
30ä¸‡ä»¥ä¸Šã®ç¤¾å“¡ã¯10%æ¸›çµ¦ã—ã¦ã€20ä¸‡ä»¥ä¸Š30ä¸‡æœªæº€ã®ç¤¾å“¡ã¯20%æ˜‡çµ¦ã™ã‚‹ ã¨ã„ã£ãŸè¦ä»¶ã®å ´åˆã€
UPDATEæ–‡ã‚’2å›žå®Ÿè¡Œã™ã‚‹ã¨ä¸æ•´åˆãŒèµ·ãã¦ã—ã¾ã†ã€‚
CASEå¼ã‚’ä½¿ã£ã¦1å›žã®UPDATEã«ã§ãã‚‹ã€‚
```sql
UPDATE
  TestSal
SET
  salary = (
    CASE
      WHEN salary >= 300000 THEN salary * (1 - 0.1) -- 30ä¸‡ä»¥ä¸Šã®ç¤¾å“¡ã¯10%æ¸›çµ¦
      WHEN salary >= 200000 AND salary < 300000 THEN salary * (1 + 0.2) -- 20ä¸‡ä»¥ä¸Š30ä¸‡æœªæº€ã®ç¤¾å“¡ã¯20%æ˜‡çµ¦
      ELSE salary
    END
  )
;
```

### 2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«é–“ã§ã®ãƒžãƒƒãƒãƒ³ã‚°
CourseMasterãƒ†ãƒ¼ãƒ–ãƒ«
| course_id | course_name(è¬›åº§å) |
| - | - |

OpenCoursesãƒ†ãƒ¼ãƒ–ãƒ«
| month(è¬›åº§ã®å®Ÿæ–½æœˆ) | course_id |
| - | - |

```sql
SELECT
  course_name,
  CASE
    WHEN EXISTS(
      SELECT
        course_id
      FROM
        `OpenCourses` oc
      WHERE
        oc.course_id = cm.course_id
      AND MONTH = 200706
    ) THEN "â—¯"
    ELSE "âœ•"
  END AS "6æœˆ",
  CASE
    WHEN EXISTS(
      SELECT
        course_id
      FROM
        `OpenCourses` oc
      WHERE
        oc.course_id = cm.course_id
      AND MONTH = 200707
    ) THEN "â—¯"
    ELSE "âœ•"
  END AS "7æœˆ",
  CASE
    WHEN EXISTS(
      SELECT
        course_id
      FROM
        `OpenCourses` oc
      WHERE
        oc.course_id = cm.course_id
      AND MONTH = 200708
    ) THEN "â—¯"
    ELSE "âœ•"
  END AS "8æœˆ"
FROM
  `CourseMaster` cm
;
```

:::message
#### existså¥
existsã®å†…ã®SQLãŒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ããŸã¨ãï¼ˆãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨(exist)ã™ã‚‹ã¨ãï¼‰ã®ã¿ã€
existsã®å¤–ã®SQLãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚
```sql:æ§‹æ–‡
SELECT *
FROM ãƒ†ãƒ¼ãƒ–ãƒ«1
WHERE exists (
  select *
  from ãƒ†ãƒ¼ãƒ–ãƒ«2
  where æ¡ä»¶
);
```
https://itsakura.com/sql-exists
:::

CASEå¼ã¯ã€æ–‡ã§ã¯ãªãå¼ã§ã‚ã‚Šã€**1ã¤ã®å€¤ã«å®šã¾ã‚‹**ã‚‚ã®ã€‚
ã ã‹ã‚‰ã€SELECTå¥ã‚„WHEREå¥ãªã©ã€ã©ã“ã«ã§ã‚‚æ›¸ãã“ã¨ãŒã§ãã‚‹ã€‚


ã€€2 å¿…ãšã‚ã‹ã‚‹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–¢æ•°
ã€€Column ãªãœONã§ã¯ãªãOVERãªã®ã‹ï¼Ÿ
ã€€3ã€€è‡ªå·±çµåˆã®ä½¿ã„æ–¹
ã€€Column SQL ã¨ãƒ•ã‚©ãƒ³ãƒ»ãƒŽã‚¤ãƒžãƒ³
ã€€4ã€€3å€¤è«–ç†ã¨NULL
ã€€Column æ–‡å­—åˆ—ã¨NULL
ã€€5ã€€EXISTSè¿°èªžã®ä½¿ã„æ–¹
ã€€6ã€€HAVINGå¥ã®åŠ›
ã€€Column é–¢ä¿‚é™¤ç®—
ã€€Column HAVING å¥ã¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–¢æ•°
ã€€7ã€€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–¢æ•°ã§è¡Œé–“æ¯”è¼ƒã‚’è¡Œãªã†
ã€€8ã€€å¤–éƒ¨çµåˆã®ä½¿ã„æ–¹
ã€€9ã€€SQLã§é›†åˆæ¼”ç®—
ã€€10ã€€SQLã§æ•°åˆ—ã‚’æ‰±ã†
ã€€11ã€€SQLã‚’é€Ÿãã™ã‚‹ãž
ã€€12ã€€SQLãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ä½œæ³•

# ç¬¬2éƒ¨ã€€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä¸–ç•Œ
ã€€13ã€€RDBè¿‘ç¾ä»£å²
ã€€14ã€€ãªãœâ€œé–¢ä¿‚â€ãƒ¢ãƒ‡ãƒ«ã¨ã„ã†åå‰ãªã®ï¼Ÿ
ã€€15ã€€é–¢ä¿‚ã«å§‹ã¾ã‚Šé–¢ä¿‚ã«çµ‚ã‚ã‚‹
ã€€16ã€€ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã“ã®å·¨å¤§ãªæ€ªç‰©
ã€€17ã€€é †åºã‚’ã‚ãã‚‹å†’é™º
ã€€18ã€€GROUP BYã¨PARTITION BY
ã€€19ã€€æ‰‹ç¶šãåž‹ã‹ã‚‰å®£è¨€åž‹ãƒ»é›†åˆæŒ‡å‘ã¸é ­ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹7ç®‡æ¡
ã€€20ã€€ç¥žã®ã„ãªã„è«–ç†
ã€€21ã€€SQLã¨å†å¸°é›†åˆ
ã€€22ã€€NULLæ’²æ»…å§”å“¡ä¼š
ã€€23ã€€SQLã«ãŠã‘ã‚‹å­˜åœ¨ã®éšŽå±¤

<!-- èª²é¡Œ -->
<!-- 1. ç¢ºå®Ÿã«é…ããªã‚‹æ‚ªã„ä¾‹ã‚’ï¼“ã¤ -->
  <!-- å®Ÿè¡Œè¨ˆç”»ã‚’ã¡ã‚ƒã‚“ã¨ãƒ¬ãƒãƒ¼ãƒˆã«å…¥ã‚Œã¦èª¬æ˜Ž -->
<!-- 2. WITH RECURSIVE æ§‹æ–‡ã‚’ä½¿ã†ã¨è‰¯ã„æ™‚, ä½¿ã£ã¦ã¯ã‚¤ã‚±ãƒŠã‚¤æ™‚ã®èª¬æ˜Ž -->