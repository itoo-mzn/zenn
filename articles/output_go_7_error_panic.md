---
title: "Go ã‚¨ãƒ©ãƒ¼å‡¦ç†ã€ãƒ‘ãƒ‹ãƒƒã‚¯"
emoji: "ğŸ‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Go"]
published: true
---

# ã‚¨ãƒ©ãƒ¼å‡¦ç†

```go
data, err := getData()
if err != nil {
  // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
}
```

ä¸Šã®æ›¸ãæ–¹ã‚ˆã‚Šã‚‚errå¤‰æ•°ã®ã‚¹ã‚³ãƒ¼ãƒ—ãŒå°ã•ãã™ã‚‹ã«ã¯ã€ä¸‹ã®ã‚ˆã†ã«ä»£å…¥ä»˜ãifæ–‡ã§errå¤‰æ•°ã‚’ä½œæˆã™ã‚‹ã€‚
```go:ä»£å…¥ä»˜ãifæ–‡ã§errå¤‰æ•°ã‚’ä½œæˆ
if err := f(); err != nil {
  // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
}
```

## ã‚¨ãƒ©ãƒ¼å‡¦ç†ã§å¤§äº‹ãªã“ã¨
- å¿…è¦ååˆ†ãªæ­£ã—ã„æƒ…å ±ã‚’ä¼ãˆã‚‹ã“ã¨ã€‚
- ç›¸æ‰‹ã«ã‚ˆã£ã¦ã€ä¼ãˆã‚‹ã¹ãæƒ…å ±ã‚’è€ƒãˆã¦è¿”ã™ã“ã¨ã€‚

## ã‚¨ãƒ©ãƒ¼å‡¦ç†ã«é–¢ã™ã‚‹æ¨å¥¨äº‹é …

Go ã§ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã™ã‚‹å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ãªæ¨å¥¨äº‹é …ã‚’è€ƒæ…®ã™ã‚‹ã“ã¨ã€‚

1. ã‚¨ãƒ©ãƒ¼ãŒäºˆæƒ³ã•ã‚Œã¦ã„ãªãã¦ã‚‚ã€**ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ã©ã†ã‹ã‚’å¸¸ã«ç¢ºèª**ã—ã¾ã™ã€‚
   ãã®ã†ãˆã§ã€**ä¸è¦ãªæƒ…å ±ãŒã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¬é–‹ã•ã‚Œãªã„ã‚ˆã†ã«**ã—ã¾ã™ã€‚
   (ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®æœ€ã‚‚ç°¡å˜ãªæ–¹æ³•ã¯ã€if æ¡ä»¶ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨)
2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«**ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å«ã‚ã¦ã€ã‚¨ãƒ©ãƒ¼ã®ç™ºç”Ÿå…ƒãŒã‚ã‹ã‚‹ã‚ˆã†ã«**ã—ã¾ã™ã€‚
   ãŸã¨ãˆã°ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚„é–¢æ•°ã®åå‰ã‚’å«ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
3. å¯èƒ½ãªé™ã‚Šã€**å†åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ©ãƒ¼å¤‰æ•°**ã‚’ä½œæˆã—ã¾ã™ã€‚
4. ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã“ã¨ã¨ã€ãƒ‘ãƒ‹ãƒƒã‚¯ã®é•ã„ã‚’ç†è§£ã—ã¾ã™ã€‚
   **ä»–ã«å¯¾å‡¦æ–¹æ³•ãŒãªã„å ´åˆã¯ã€ãƒ‘ãƒ‹ãƒƒã‚¯**ãŒç™ºç”Ÿã—ã¾ã™ã€‚
   ãŸã¨ãˆã°ã€ä¾å­˜é–¢ä¿‚ã®æº–å‚™ãŒã§ãã¦ã„ãªã„å ´åˆã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯å‹•ä½œã—ã¾ã›ã‚“ (æ—¢å®šã®å‹•ä½œã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã‚’é™¤ãã¾ã™)ã€‚
5. å¯èƒ½ãªé™ã‚Šå¤šãã®è©³ç´°æƒ…å ±ã§ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã—ã€ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç†è§£å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```go:
type Employee struct {
  ID        int
  FirstName string
  LastName  string
  Address   string
}

func main() {
  employee, err := getInformation(1001)
  if err != nil {
    // ãªã«ã‹ã™ã‚‹
  } else {
    fmt.Println(employee)
  }
}

func getInformation(id int) (*Employee, error) {
  employee, err := apiCallEmployee(1000)

  // ä¿®æ­£å‰
  // return employee, err

  // ä¿®æ­£å¾Œ
  // 1. ã‚¨ãƒ©ãƒ¼ãŒäºˆæƒ³ã•ã‚Œã¦ã„ãªãã¦ã‚‚ã€ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ã©ã†ã‹ã‚’å¸¸ã«ç¢ºèªã—ã¾ã™ã€‚
  //   ãã®ã†ãˆã§ã€ä¸è¦ãªæƒ…å ±ãŒã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¬é–‹ã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚
  if err != nil {
    return nil, err // apiCallEmployee()ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ãŒè¿”ã£ã¦æ¥ã¦ã„ã‚‹å ´åˆã¯ã€errã®ã¿è¿”ã™
  }
  return employee, nil
}

// 3. å¯èƒ½ãªé™ã‚Šã€å†åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ©ãƒ¼å¤‰æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚
var ErrNotFound = errors.New("Employee not found")

func apiCallEmployee(id int) (*Employee, error) {
  if id != 1001 {
    return nil, ErrNotFound
  }

  employee := Employee{LastName: "hoge", FirstName: "john"}
  return &employee, nil
}
```

## ã‚¨ãƒ©ãƒ¼ã«æ–‡è„ˆã‚’ã‚‚ãŸã›ã‚‹
`fmt.Errorf`ã®`%w`ã‚’ä½¿ã†ã“ã¨ã§ã€æ—¢ã«ã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã«ãƒ©ãƒƒãƒ—ã—ãŸï¼ˆ1æšä¸Šä¹—ã›ã—ãŸï¼‰ã‚¨ãƒ©ãƒ¼ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

ã¾ãŸã€ãã†ã‚„ã£ã¦ä¸Šä¹—ã›ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã®æ ¹æœ¬ï¼ˆæ ¹æœ¬åŸå› ï¼‰ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€`errors.Unwrap()`ã‚’ä½¿ã†ã€‚

```go
err := fmt.Errorf("bar: %w", errors.New("foo"))
fmt.Println(err) // bar: foo
fmt.Println(errors.Unwrap(err)) // foo
```

## ã‚¨ãƒ©ãƒ¼ã®å€¤ã‚’åˆ¤å®šã™ã‚‹
`errors.Is`ã§ã€ç¬¬ä¸€å¼•æ•°ã®ã‚¨ãƒ©ãƒ¼ãŒç¬¬äºŒå¼•æ•°ã®å€¤ã‹ã©ã†ã‹ã‚’åˆ¤å®šã§ãã‚‹ã€‚
```go
if errors.Is(err, os.ErrExist) {
  // os.ErrExistã ã£ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
}
```

# ä¾‹å¤–å‡¦ç†

panic ã¨ recover ã®çµ„ã¿åˆã‚ã›ã¯ã€Go ã§ã®ç‰¹å¾´çš„ãªä¾‹å¤–å‡¦ç†æ–¹æ³•ã€‚
ï¼ˆä»–ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã¯ã€try/catchã€‚ï¼‰

:::message alert
## ã‚¨ãƒ©ãƒ¼ã¨ãƒ‘ãƒ‹ãƒƒã‚¯ï¼ˆä¾‹å¤–ï¼‰ã®ä½¿ã„åˆ†ã‘
**panicã¯å›é¿ä¸å¯èƒ½ãªå ´åˆã®ã¿**ä½¿ã†ã€‚

æƒ³å®šå†…ã®ã‚¨ãƒ©ãƒ¼ã¯errorå‹ã§å‡¦ç†ã™ã‚‹ã€‚
:::

## panic é–¢æ•°

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å¼·åˆ¶çš„ã«ãƒ‘ãƒ‹ãƒƒã‚¯ã«ã™ã‚‹ã€‚ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã—ã¦ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ã€‚

```go
import "fmt"

func main() {
  g(0) // é–¢æ•°g()ã‚’å®Ÿè¡Œ
  fmt.Println("finish") // panicã«ã‚ˆã‚Šã€ã“ã®è¡Œã¯å®Ÿè¡Œã•ã‚Œãªã„
}

func g(i int) {
  if i > 3 {
    fmt.Println("ãƒ‘ãƒ‹ãƒƒã‚¯å‰") // 2. panicå‰ã®å‡¦ç†ã¯ã€ãµã¤ã†ã«2ç•ªç›®ã«å®Ÿè¡Œã•ã‚Œã‚‹
    panic("ãƒ‘ãƒ‹ãƒƒã‚¯") // 4. deferã®å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹
  }

  defer fmt.Println("defer:", i) // 3. panic("ãƒ‘ãƒ‹ãƒƒã‚¯")ã‚ˆã‚Šå…ˆã«å®Ÿè¡Œã•ã‚Œã‚‹

  fmt.Println("print:", i) // 1. ã¾ãšã¯ã“ã®è¡ŒãŒå®Ÿè¡Œã•ã‚Œã‚‹
  g(i + 1) // å†å¸°(panicãŒç„¡ã‘ã‚Œã°ã€ç„¡é™ã«ç¹°ã‚Šè¿”ã™)
}

/* å‡ºåŠ›
  print: 0
  print: 1
  print: 2
  print: 3
  ãƒ‘ãƒ‹ãƒƒã‚¯å‰
  defer: 3
  defer: 2
  defer: 1
  defer: 0
  panic: ãƒ‘ãƒ‹ãƒƒã‚¯

  goroutine 1 [running]:
  main.g(0x4)
          /Users/itotakuya/projects/go/src/helloworld/main.go:329 +0x22e
  main.g(0x3)
          /Users/itotakuya/projects/go/src/helloworld/main.go:335 +0x17a
  main.g(0x2)
          /Users/itotakuya/projects/go/src/helloworld/main.go:335 +0x17a
  main.g(0x1)
          /Users/itotakuya/projects/go/src/helloworld/main.go:335 +0x17a
  main.g(0x0)
          /Users/itotakuya/projects/go/src/helloworld/main.go:335 +0x17a
  main.main()
          /Users/itotakuya/projects/go/src/helloworld/main.go:322 +0x2e
  exit status 2
*/
```

## recover é–¢æ•°

`panic()`å¾Œã«ã€åˆ¶å¾¡ã§ãã‚‹ã€‚
`defer()`ã®ä¸­ã§å®Ÿè¡Œã§ãã‚‹ã€‚
`panic()`ã¨é•ã„ã€ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã—ãªã„ã€‚

```go
import "fmt"

func main() {
  defer func() { // 5. panicãŒç™ºç”Ÿã—ãŸã®ã§ã€deferã®å¾Œã§å®Ÿè¡Œã•ã‚Œã‚‹
    if r := recover(); r != nil { // panicãŒèµ·ããŸã¨ãã«ã€catchã™ã‚‹ã‚ˆã†äºˆç´„
      fmt.Println("ãƒªã‚«ãƒãƒ¼ã—ãŸ", r) // r = "ãƒ‘ãƒ‹ãƒƒã‚¯"
    }
  }()

  g(0)
  fmt.Println("finish!!") // panicã«ã‚ˆã‚Šã€ã“ã®è¡Œã¯å®Ÿè¡Œã•ã‚Œãªã„
}

func g(i int) {
  if i > 3 {
    fmt.Println("ãƒ‘ãƒ‹ãƒƒã‚¯å‰") // 2. panicå‰ã®å‡¦ç†ã¯ã€ãµã¤ã†ã«2ç•ªç›®ã«å®Ÿè¡Œã•ã‚Œã‚‹
    panic("ãƒ‘ãƒ‹ãƒƒã‚¯") // 4. panicç™ºç”Ÿ
  }

  defer fmt.Println("defer:", i) // 3. recover() ã‚ˆã‚Šå…ˆã«å®Ÿè¡Œã•ã‚Œã‚‹

  fmt.Println("print:", i) // 1. ã¾ãšã¯ã“ã®è¡ŒãŒå®Ÿè¡Œã•ã‚Œã‚‹
  g(i + 1) // å†å¸°(panicãŒç„¡ã‘ã‚Œã°ã€ç„¡é™ã«ç¹°ã‚Šè¿”ã™)
}

/* å‡ºåŠ›
  print: 0
  print: 1
  print: 2
  print: 3
  ãƒ‘ãƒ‹ãƒƒã‚¯å‰
  defer: 3
  defer: 2
  defer: 1
  defer: 0
  ãƒªã‚«ãƒãƒ¼ã—ãŸ ãƒ‘ãƒ‹ãƒƒã‚¯
/*
```

https://qiita.com/Maki-Daisuke/items/80cbc26ca43cca3de4e4

